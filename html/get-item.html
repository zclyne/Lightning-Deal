<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <link href="static/assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
    <link href="static/assets/global/css/components.css" rel="stylesheet" type="text/css" />
    <link href="static/assets/admin/pages/css/login.css" rel="stylesheet" type="text/css" />
    <script src="static/assets/global/plugins/jquery-1.11.0.min.js" type="text/javascript"></script>
    <script src="./get-host.js" type="text/javascript"></script>
</head>
<body class="login">
<div class="content">
    <div class="form-group" id="promo-start-date-container">
        <label style="color: blue;" id="promo-status" class="control-label"></label>
        <div>
            <label style="color: red;" class="control-label" id="promo-start-date" />
        </div>
    </div>
    <h3 class="form-title">商品详情</h3>
    <div class="form-group">
        <div>
            <label class="control-label" id="title" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品描述</label>
        <div>
            <label class="control-label" id="description" />
        </div>
    </div>
    <div class="form-group" id="normal-price-container">
        <label class="control-label">商品价格</label>
        <div>
            <label class="control-label" id="price" />
        </div>
    </div>
    <div class="form-group" id="promo-price-container">
        <label style="color: red;" class="control-label">秒杀价格</label>
        <div>
            <label style="color: red;" class="control-label" id="promo-price" />
        </div>
    </div>
    <div class="form-group">
        <div>
            <img style="width: 200px; height: auto;" src="" alt="" id="imgUrl">
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品库存</label>
        <div>
            <label class="control-label" id="stock" />
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">商品销量</label>
        <div>
            <label class="control-label" id="sales" />
        </div>
    </div>
    <div class="form-actions">
        <button class="btn blue" id="create-order" type="submit">
            下单
        </button>
    </div>
</div>
</body>

<script>

    // 全局商品信息
    var g_itemVO = {};

    //获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }

    jQuery(document).ready(function () {
        // 用户点击下单按钮
        $("#create-order").on("click", function () {
            // 从localStorage中取出token，之后要将其传给服务器作为用户登录的凭证
            // 这里必须在前后端都对token做验证，因为即使前端有token，后端的redis可能清空过，没有该用户的token
            var token = window.localStorage["token"];
            if (token == null) { // 如果没有token，直接提示并返回false
                alert("没有登录，不能下单");
                window.location.href="./login.html";
                return false;
            }
            $.ajax({
                type: "POST",
                url: g_host + "/order/generatetoken?token=" + token,
                data: {
                    "itemId": g_itemVO.id,
                    "promoId": g_itemVO.promoId
                },
                xhrFields: {
                    withCredentials: true
                },
                success: function(data) {
                    if (data.status === "success") {
                        var promoToken = data.data;
                        // 使用秒杀活动令牌来下单
                        $.ajax({
                            type: "POST",
                            // 把token添加在url中。这里虽然是POST，但是这种操作完全合法
                            url: g_host + "/order/createorder?token=" + token,
                            data: {
                                "itemId": g_itemVO.id,
                                "amount": 1,
                                "promoId": g_itemVO.promoId,
                                "promoToken": promoToken
                            },
                            xhrFields: {
                                withCredentials: true
                            },
                            success: function(data) {
                                if (data.status === "success") {
                                    alert("下单成功！");
                                    // 刷新页面，看到销量和库存的变化
                                    window.location.reload();
                                } else {
                                    alert("下单失败，原因为" + data.data.errMsg);
                                    if (data.data.errCode == 20003) { // 用户未登录错误，跳转到登录页
                                        window.location.href = "./login.html";
                                    }
                                }
                            },
                            error: function(data) {
                                alert("下单失败，原因为" + data.responseText);
                                if (data.data.errCode == 20003) { // 用户未登录错误，跳转到登录页
                                    window.location.href = "./login.html";
                                }
                            }
                        });
                    } else {
                        alert("获取token失败，原因为" + data.data.errMsg);
                    }
                },
                error: function(data) {
                    alert("获取token失败，原因为" + data.responseText);
                }
            })
        });

        // 获取商品详情
        $.ajax({
            type: "GET",
            url: g_host + "/item/get",
            contentType: "application/x-www-form-urlencoded",
            data: {
                "id": getUrlParam("id")
            },
            xhrFields: {
                withCredentials: true
            },
            success: function(data) {
                if (data.status === "success") {
                    g_itemVO = data.data;
                    reloadDom();
                    setInterval(reloadDom, 1000); // 设置定时器，以使在秒杀活动开始时重新加载dom，启用button
                } else {
                    alert("获取商品信息失败，原因为" + data.data.errMsg);

                }
            },
            error: function(data) {
                alert("获取商品信息失败，原因为" + data.responseText);
            }
        });
    });

    function reloadDom() {
        $('#title').text(g_itemVO.title);
        $('#description').text(g_itemVO.description);
        $('#stock').text(g_itemVO.stock);
        $('#price').text(g_itemVO.price);
        $('#sales').text(g_itemVO.sales);
        $('#imgUrl').attr("src", g_itemVO.imgUrl);
        if (g_itemVO.promoStatus === 1) { // 秒杀活动未开始
            // 把string格式的开始时间转换成js可识别的时间，用于计算倒计时
            var startTime = g_itemVO.startDate.replace(new RegExp("-", "gm"), "/");
            startTime = (new Date(startTime)).getTime();
            var nowTime = Date.parse(new Date());
            var delta = (startTime - nowTime) / 1000; // 减得的结果是毫秒数
            if (delta <= 0) { // 活动已经开始
                g_itemVO.promoStatus = 2;
                reloadDom();
            }
            $('#promo-start-date').text("秒杀活动将于：" + g_itemVO.startDate + " 开始，倒计时：" + delta + "秒");
            $('#promo-price').text(g_itemVO.promoPrice);
            // 禁用下单按钮
            $('#create-order').attr("disabled", true);
        } else if (g_itemVO.promoStatus === 2) { // 秒杀活动正在进行中
            $('#promo-start-date').text("秒杀活动正在进行中");
            $('#promo-price').text(g_itemVO.promoPrice);
            $('#create-order').attr("disabled", false);
            // 隐藏原始价格
            $('#normal-price-container').hide();
        } else { // 商品没有秒杀活动
            $('#promo-status').text("此商品暂无秒杀活动");
            $('#promo-price').text("此商品暂无秒杀活动");
        }
    }

</script>

</html>